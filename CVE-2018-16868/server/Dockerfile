FROM debian:stretch
RUN sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list \
 && sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list \
 && sed -i '/stretch-updates/d' /etc/apt/sources.list \
 && echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until

RUN apt-get update && apt-get install -y \
    build-essential wget ca-certificates pkg-config \
    m4 \
    libp11-kit-dev libunistring-dev libidn2-0-dev libtasn1-6-dev \
    libz-dev libffi-dev libgmp-dev texinfo \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# 1) Build Nettle (chọn phiên bản < 3.4.1, ví dụ 3.4)
RUN wget -q https://ftp.gnu.org/gnu/nettle/nettle-3.4.tar.gz \
 && tar xzf nettle-3.4.tar.gz \
 && cd nettle-3.4 \
 && ./configure --prefix=/opt/nettle-3.4 \
 && make -j"$(nproc)" \
 && make install

ENV PKG_CONFIG_PATH=/opt/nettle-3.4/lib/pkgconfig
ENV LD_LIBRARY_PATH=/opt/nettle-3.4/lib

# 2) Build GnuTLS 3.6.4 (vulnerable theo NVD)
RUN wget -q https://www.gnupg.org/ftp/gcrypt/gnutls/v3.6/gnutls-3.6.4.tar.xz \
 && tar xf gnutls-3.6.4.tar.xz \
 && cd gnutls-3.6.4 \
 && ./configure --prefix=/opt/gnutls-3.6.4 --with-included-unistring=no \
 && make -j"$(nproc)" \
 && make install

ENV PATH=/opt/gnutls-3.6.4/bin:$PATH

COPY gencert.sh /src/gencert.sh
RUN chmod +x /src/gencert.sh
CMD ["/src/gencert.sh"]